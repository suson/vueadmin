(function($){var defaults={'title':null,'fixed':true,'center':true,'clone':true,'x':0,'y':0,'modal':true,'modalClose':true,'resize':true,'unload':false,'close':'[关闭]','escHide':true,'delayClose':0,'drag':false,'display':true,'width':'','height':'','dataEle':'','locate':['left','top'],'show':['fadeIn','normal'],'hide':['fadeOut','normal'],'button':[],'style':'default','titleChange':undefined,'beforeShow':undefined,'afterShow':undefined,'afterHide':undefined,'beforeUnload':undefined,'afterDrag':undefined};var zIndex=2012;var current=null;var wrapper=['<div class="ThinkBox-wrapper" style="position:absolute;width: auto">','<table cellspacing="0" cellpadding="0" border="0" style="width: auto">','<tr>','<td class="box-top-left"></td>','<td class="box-top"></td>','<td class="box-top-right"></td>','</tr>','<tr>','<td class="box-left"></td>','<td class="ThinkBox-inner"></td>','<td class="box-right"></td>','</tr>','<tr>','<td class="box-bottom-left"></td>','<td class="box-bottom"></td>','<td class="box-bottom-right"></td>','</tr>','</table>','</div>'].join('');var titleBar=['<tr class="ThinkBox-title">','<td class="box-title-left"></td>','<td class="ThinkBox-title-inner"></td>','<td class="box-title-right"></td>','</tr>'].join('');var toolsBar=['<tr class="ThinkBox-tools">','<td class="box-tools-left"></td>','<td class="ThinkBox-tools-inner"></td>','<td class="box-tools-right"></td>','</tr>'].join('');var _doc=$(document),_win=$(window);var ThinkBox=function(element,options){var self=this,visible=false,modal=null;var options=$.extend({},defaults,options||{});var box=$(wrapper).addClass('ThinkBox-'+options.style).data('ThinkBox',this);options.dataEle&&$(options.dataEle).data('ThinkBox',this);box.hover(function(){_fire.call(self,options.mouseover)},function(){_fire.call(self,options.mouseout)}).mousedown(function(event){_setCurrent();event.stopPropagation()}).click(function(event){event.stopPropagation()});_setContent(element||'<div></div>');options.title!==null&&_setupTitleBar();options.button.length&&_setupToolsBar();options.close&&_setupCloseBtn();box.css('display','none').appendTo('body');var left=box.find('.box-left');left.append($('<div/>').css('width',left.width()));this.hide=_hide;this.show=_show;this.toggle=function(){visible?self.hide():self.show()};this.getContent=function(){return $('.ThinkBox-content',box)};this.setContent=function(content){_setContent(content);_setLocate();return self;};this.setTitle=_setTitle;this.getSize=_getSize;this.setSize=function(width,height){$('.ThinkBox-inner',box).css({'width':width,'height':height});};options.fixed&&($.browser.msie&&$.browser.version<7?options.fixed=false:box.css('position','fixed'));_setLocate();options.resize&&_win.resize(function(){_setLocate()});self.escHide=options.escHide;options.display&&_show();function _show(){if(visible)return self;options.modal&&_setupModal();_fire.call(self,options.beforeShow);switch(options.show[0]){case 'slideDown':box.stop(true,true).slideDown(options.show[1],_);break;case 'fadeIn':box.stop(true,true).fadeIn(options.show[1],_);break;default:box.show(options.show[1],_);}
visible=true;_setCurrent();return self;function _(){options.delayClose&&$.isNumeric(options.delayClose)&&setTimeout(_hide,options.delayClose);_fire.call(self,options.afterShow);}};function _hide(){if(!visible)return self;modal&&modal.fadeOut('normal',function(){$(this).remove();modal=null});switch(options.hide[0]){case 'slideUp':box.stop(true,true).slideUp(options.hide[1],_);break;case 'fadeOut':box.stop(true,true).fadeOut(options.hide[1],_);break;default:box.hide(options.hide[1],_);}
return self;function _(){visible=false;_fire.call(self,options.afterHide);options.unload&&_unload();}}
function _setupTitleBar(){var bar=$(titleBar);var title=$('.ThinkBox-title-inner',bar);if(options.drag){title.addClass('ThinkBox-draging');title[0].onselectstart=function(){return false};title[0].unselectable='on';title[0].style.MozUserSelect='none';_drag(title);}
$('tr',box).first().after(bar);_setTitle(options.title);}
function _setTitle(title){var titleInner=$('.ThinkBox-title-inner',box).empty();if($.isArray(title)||$.isPlainObject(title)){$.each(title,function(i,_title){$('<span>'+_title+'</span>').data('key',i).click(function(event){var _this=$(this);if(!_this.hasClass('selected')){titleInner.find('span.selected').removeClass('selected');_this.addClass('selected');_fire.call(_this,options.titleChange);}}).mousedown(function(event){event.stopPropagation()}).mouseup(function(event){event.stopPropagation()}).appendTo(titleInner);});}else{titleInner.append('<span>'+title+'</span>');}}
function _setupToolsBar(){var bar=$(toolsBar);var tools=$('.ThinkBox-tools-inner',bar);var button=null;$.each(options.button,function(k,v){button=$('<span/>').addClass('ThinkBox-button '+v[0]).html(v[1]).click(function(){_fire.call(self,v[2])}).hover(function(){$(this).addClass('hover')},function(){$(this).removeClass('hover')}).appendTo(tools);})
$('tr',box).last().before(bar);}
function _setupCloseBtn(){$('<span/>').addClass('ThinkBox-close').html(options.close).click(function(event){self.hide();event.stopPropagation()}).mousedown(function(event){event.stopPropagation()}).appendTo($('.ThinkBox-inner',box));}
function _setupModal(){if($.browser.msie){_doc.width=function(){return document.documentElement.scrollWidth};_doc.height=function(){return document.documentElement.scrollHeight};}
modal=$('<div class="ThinkBox-modal-blackout" style="position:absolute;left:0;top:0"></div>').addClass('ThinkBox-modal-blackout-'+options.style).css({'zIndex':zIndex++,'width':_doc.width(),'height':_doc.height()}).click(function(event){options.modalClose&&current&&current.hide();event.stopPropagation();}).mousedown(function(event){event.stopPropagation()}).appendTo($('body'));_win.resize(function(){modal&&modal.css({'width':'','height':''}).css({'width':_doc.width(),'height':_doc.height()});});}
function _setContent(content){var content=$('<div/>').addClass('ThinkBox-content').append((options.clone?$(content).clone(true,true):$(content)).show());$('.ThinkBox-content',box).remove();$('.ThinkBox-inner',box).css({'width':options.width,'height':options.height}).append(content);}
function _setLocate(){options.center?_moveToCenter():_moveTo($.isNumeric(options.x)?options.x:($.isFunction(options.x)?options.x.call($(options.dataEle)):0),$.isNumeric(options.y)?options.y:($.isFunction(options.y)?options.y.call($(options.dataEle)):0));}
function _drag(title){var draging=null;_doc.mousemove(function(event){draging&&box.css({left:event.pageX-draging[0],top:event.pageY-draging[1]});});title.mousedown(function(event){var offset=box.offset();if(options.fixed){offset.left-=_win.scrollLeft();offset.top-=_win.scrollTop();}
draging=[event.pageX-offset.left,event.pageY-offset.top];}).mouseup(function(){draging=null;_fire.call(self,options.afterDrag);});}
function _moveToCenter(){var s=_getSize(),v=viewport(),o=box.css('position')=='fixed'?[0,0]:[v.left,v.top],x=o[0]+v.width/2,y=o[1]+v.height/2;_moveTo(x-s[0]/2,y-s[1]/2);}
function _moveTo(x,y){$.isNumeric(x)&&(options.locate[0]=='left'?box.css({'left':x}):box.css({'right':x}));$.isNumeric(y)&&(options.locate[1]=='top'?box.css({'top':y}):box.css({'bottom':y}));}
function _getSize(){if(visible)
return[box.width(),box.height()];else{box.css({'visibility':'hidden','display':'block'});var size=[box.width(),box.height()];box.css('display','none').css('visibility','visible');return size;}}
function _unload(){_fire.call(self,options.beforeUnload);box.remove();options.dataEle&&$(options.dataEle).removeData('ThinkBox');}
function _setCurrent(){current=self;_toTop.call(box);}};function _toTop(){this.css({'zIndex':zIndex++});}
function viewport(){return $.extend({'width':_win.width(),'height':_win.height()},{'left':_win.scrollLeft(),'top':_win.scrollTop()});}
function _fire(event){$.isFunction(event)&&event.call(this);}
function _delOptions(opt,options){$.each(opt,function(){if(this in options)delete options[this];});}
_doc.mousedown(function(){current=null}).keypress(function(event){current&&current.escHide&&event.keyCode==27&&current.hide()});$.ThinkBox=function(element,options){if($.isPlainObject(options)&&options.dataEle){var data=$(options.dataEle).data('ThinkBox');if(data)return options.display===false?data:data.show();}
return new ThinkBox(element,options);}
$.extend($.ThinkBox,{load:function(url,opt){var options={'clone':false,'loading':'加载中...','type':'GET','dataType':'text','cache':false,'parseData':undefined,'onload':undefined},self;$.extend(options,opt||{});var parseData=options.parseData,onload=options.onload,loading=options.loading,url=url.split(/\s+/);var ajax={'data':options.data,'type':options.type,'dataType':options.dataType,'cache':options.cache,'success':function(data){url[1]&&(data=$(data).find(url[1]));$.isFunction(parseData)&&(data=parseData.call(options.dataEle,data));self.setContent(data);_fire.call(self,onload);loading||self.show();}};_delOptions(['data','type','cache','dataType','parseData','onload','loading'],options);self=loading?$.ThinkBox('<div class="ThinkBox-load-loading">'+loading+'</div>',options):$.ThinkBox('<div/>',$.extend({},options,{'display':false}));$.ajax(url[0],ajax);return self;},'iframe':function(url,opt){var options={'width':500,'height':400,'scrolling':'no','onload':undefined},self;$.extend(options,opt||{});var onload=options.onload;var iframe=$('<iframe/>').attr({'width':options.width,'height':options.height,'frameborder':0,'scrolling':options.scrolling,'src':url}).load(function(){_fire.call(self,onload)});_delOptions(['width','height','scrolling','onload'],options);self=$.ThinkBox(iframe,options);return self;},'tips':function(msg,type,opt){switch(type){case 0:type='error';break;case 1:type='success';break;}
var html='<div class="ThinkBox-tips ThinkBox-'+type+'">'+msg+'</div>';var options={'modalClose':false,'escHide':false,'unload':true,'close':false,'delayClose':1000};$.extend(options,opt||{});return $.ThinkBox(html,options);},'success':function(msg,opt){return this.tips(msg,'success',opt);},'error':function(msg,opt){return this.tips(msg,'error',opt);},'loading':function(msg,opt){var options=opt||{};options.delayClose=0;return this.tips(msg,'loading',options);},'msg':function(msg,opt){var options={'drag':false,'escHide':false,'delayClose':0,'center':false,'title':'消息','x':0,'y':0,'locate':['right','bottom'],'show':['slideDown','slow'],'hide':['slideUp','slow']};$.extend(options,opt||{});var html=$('<div/>').addClass('ThinkBox-msg').html(msg);return $.ThinkBox(html,options);},'alert':function(msg,opt){var options={'title':'提示','modal':false,'modalClose':false,'unload':false},button=['ok','确定',undefined];$.extend(options,opt||{});(typeof options.okVal!='undefined')&&(button[1]=options.okVal);$.isFunction(options.ok)&&(button[2]=options.ok);_delOptions(['okVal','ok'],options);options.button=[button];var html=$('<div/>').addClass('ThinkBox-alert').html(msg);return $.ThinkBox(html,options);},'confirm':function(msg,opt){var options={'title':'确认','modal':false,'modalClose':false},button=[['ok','确定',undefined],['cancel','取消',undefined]];$.extend(options,opt||{});(typeof options.okVal!='undefined')&&(button[0][1]=options.okVal);(typeof options.cancelVal!='undefined')&&(button[1][1]=options.cancelVal);$.isFunction(options.ok)&&(button[0][2]=options.ok);$.isFunction(options.cancel)&&(button[1][2]=options.cancel);_delOptions(['okVal','ok','cancelVal','cancel'],options);options.button=button;var html=$('<div/>').addClass('ThinkBox-confirm').html(msg);return $.ThinkBox(html,options);},'get':function(selector){return $(selector).closest('.ThinkBox-wrapper').data('ThinkBox');}});$.fn.ThinkBox=function(opt){if(opt=='get')return $(this).data('ThinkBox');return this.each(function(){var self=$(this);var box=self.data('ThinkBox');switch(opt){case 'show':box&&box.show();break;case 'hide':box&&box.hide();break;case 'toggle':box&&box.toggle();break;default:var options={'title':self.attr('title'),'dataEle':this,'fixed':false,'center':false,'modal':false,'drag':false};opt=$.isPlainObject(opt)?opt:{};$.extend(options,{'x':function(){return $(this).offset().left},'y':function(){return $(this).offset().top+$(this).outerHeight()}},opt);if(options.event){var event=options.event;delete options.event;if(event=='hover'){var outClose=options.boxOutClose||false,delayShow=options.delayShow||0,timeout1=null,timeout2=null;_delOptions(['boxOutClose','delayShow'],options);options.mouseover=function(){if(timeout2){clearTimeout(timeout2);timeout2=null}};options.mouseout=function(){this.hide()};self.hover(function(){timeout1=timeout1||setTimeout(function(){_.call(self,options)},delayShow)},function(){if(timeout1){clearTimeout(timeout1);timeout1=null}
outClose?timeout2=timeout2||setTimeout(function(){timeout2=null;self.ThinkBox('hide')},50):self.ThinkBox('hide');});}else{self.bind(event,function(){_.call(self,options);return false;});}}else{_.call(self,options);}}});function _(options){var href=this.attr('think-href')||this.attr('href');if(href.substr(0,1)=='#'){$.ThinkBox(href,options);}else if(href.substr(0,7)=='http://'||href.substr(0,8)=='https://'){$.ThinkBox.iframe(href,options);}else{$.ThinkBox.load(href,options);}}}})(jQuery);